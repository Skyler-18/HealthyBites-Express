<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Food - HealthyBites Express</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f8f8f8; }
        .container { max-width: 600px; margin: 3em auto 0 auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #0001; padding: 2em 2.5em 2em 2.5em; position: relative; }
        h1, h2 { color: #2d7a2d; text-align: center; }
        .section { margin-bottom: 2em; }
        .menu-item { margin-bottom: 0.5em; }
        .desc { color: #555; font-size: 0.95em; margin-left: 1.5em; }
        .price { color: #0077cc; font-weight: bold; }
        #user-id { margin-bottom: 1em; font-size: 1.1em; text-align: center; }
        .submit-btn, .back-btn, .confirm-btn, .close-btn { background: #2d7a2d; color: #fff; border: none; padding: 0.7em 2em; font-size: 1em; border-radius: 5px; cursor: pointer; margin: 0.5em; }
        .submit-btn:hover, .back-btn:hover, .confirm-btn:hover, .close-btn:hover { background: #256b25; }
        #bill-box {
            position: fixed;
            top: 1.5em;
            right: 2em;
            background: #e6f4ea;
            border: 1px solid #b2d8c7;
            border-radius: 8px;
            padding: 1em 1.5em;
            font-size: 1.1em;
            color: #2d7a2d;
            box-shadow: 0 1px 4px #0001;
            z-index: 1000;
        }
        #summary-section {
            display: none;
            background: #f6fff6;
            border-radius: 8px;
            padding: 1.5em 1em;
            box-shadow: 0 1px 4px #0001;
            border: 2px solid red; /* DEBUG */
            z-index: 2000;         /* DEBUG */
        }
        #close-section { display: none; text-align: center; }
        @media (max-width: 700px) {
            .container { padding: 1em; }
            #bill-box { right: 1em; top: 1em; padding: 0.7em 1em; }
        }
    </style>
</head>
<body>
    <div id="bill-box">Current Bill: ‚Çπ<span id="current-bill">0</span></div>
    <div class="container">
        <h1>Today's Menu</h1>
        <div id="user-id"></div>
        <form id="order-form">
            <div id="menu"></div>
            <div style="text-align:center"><button type="submit" class="submit-btn">Place Order</button></div>
        </form>
        <div id="summary-section">
            <h2>Order Summary</h2>
            <div id="summary-list"></div>
            <div style="font-size:1.2em; margin:1em 0;">Total: ‚Çπ<span id="summary-total"></span></div>
            <div style="text-align:center">
                <button type="button" class="confirm-btn">Confirm</button>
                <button type="button" class="back-btn">Go Back</button>
            </div>
        </div>
        <div id="close-section">
            <h2>Order Placed!</h2>
            <div style="margin:1em 0 2em 0;">
                You can close this window. If you wish, you can cancel your order between 8:35am to 9am for lunch and between 4:35pm to 5pm for dinner.
            </div>
            <button class="close-btn">Close Window</button>
        </div>
    </div>
    <script>
        // Get phone from query param
        const urlParams = new URLSearchParams(window.location.search);
        const phone = urlParams.get('phone');
        document.getElementById('user-id').textContent = phone ? `Ordering as: ${phone}` : '';

        let menuData = null;
        let prices = {};
        let selectedItems = [];

        // Fetch and render menu
        fetch('/menu.json')
            .then(res => res.json())
            .then(menu => {
                menuData = menu;
                const menuDiv = document.getElementById('menu');
                menuDiv.innerHTML = '';
                // Time-based menu visibility
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                function inRange(startH, startM, endH, endM) {
                    const nowMins = hours * 60 + minutes;
                    const start = startH * 60 + startM;
                    const end = endH * 60 + endM;
                    return nowMins >= start && nowMins <= end;
                }
                const isLunchTime = inRange(6, 0, 8, 30);
                const isDinnerTime = inRange(14, 0, 23, 30);
                function renderSection(title, items, isExtra) {
                    let html = `<div class='section'><h2>${title}</h2>`;
                    items.forEach(item => {
                        const id = `${title}-${item.name}`.replace(/\s+/g, '-');
                        const price = isExtra ? item.price : 20;
                        prices[item.name] = price;
                        html += `<div class='menu-item'>
                            <input type='checkbox' id='${id}' name='order' value='${item.name}' data-price='${price}'>
                            <label for='${id}'><b>${item.name}</b> <span class='price'>‚Çπ${price}</span></label>
                            ${item.desc ? `<div class='desc'>${item.desc}</div>` : ''}
                        </div>`;
                    });
                    html += '</div>';
                    return html;
                }
                // Fetch profile to check subscription status for Save Default button logic
                fetch(`/api/profile?phone=${phone}`)
                    .then(res => res.json())
                    .then(profile => {
                        if (isLunchTime) {
                            menuDiv.innerHTML += renderSection('Lunch', menu.Lunch);
                            menuDiv.innerHTML += renderSection('Extra Items', menu.ExtraItems, true);
                            // Add Save Default button and info
                            const disable = profile.subscriptionStatus === 'Monthly_Dinner';
                            const disableMsg = disable ? 'You have subscribed for dinner plan so you can\'t save orders for lunch.' : '';
                            addSaveDefaultButton('lunch', disable, disableMsg);
                        } else if (isDinnerTime) {
                            menuDiv.innerHTML += renderSection('Dinner', menu.Dinner);
                            menuDiv.innerHTML += renderSection('Extra Items', menu.ExtraItems, true);
                            // Add Save Default button and info
                            const disable = profile.subscriptionStatus === 'Monthly_Lunch';
                            const disableMsg = disable ? 'You have subscribed for lunch plan so you can\'t save orders for dinner.' : '';
                            addSaveDefaultButton('dinner', disable, disableMsg);
                        } else {
                            menuDiv.innerHTML = `<div style='text-align:center;font-size:1.2em;margin:2em 0;'>We take orders only between 6AM and 8:30AM for lunch and 2PM and 4:30PM for dinner.</div>`;
                            document.querySelector('.submit-btn').style.display = 'none';
                        }
                        updateBill();
                    });
            });

        // Bill calculation
        function updateBill() {
            const checked = Array.from(document.querySelectorAll('input[name="order"]:checked'));
            let total = 0;
            checked.forEach(cb => {
                total += parseInt(cb.getAttribute('data-price'));
            });
            document.getElementById('current-bill').textContent = total;
        }
        document.addEventListener('change', function(e) {
            if (e.target && e.target.name === 'order') updateBill();
        });

        // Order form submit
        document.getElementById('order-form').addEventListener('submit', function(e) {
            e.preventDefault();
            selectedItems = Array.from(document.querySelectorAll('input[name="order"]:checked')).map(cb => cb.value);
            console.log('Selected items:', selectedItems);
            if (selectedItems.length === 0) {
                alert('Please select at least one item.');
                return;
            }
            // Show summary
            document.getElementById('order-form').style.display = 'none';
            document.getElementById('summary-section').style.display = 'block';
            console.log('Showing summary section');
            showSummary();
        });

        function showSummary() {
            const summarySection = document.getElementById('summary-section');
            const summaryList = document.getElementById('summary-list');
            let total = 0;
            summaryList.innerHTML = '<ul style="list-style:none;padding:0;">' + selectedItems.map(item => {
                const price = prices[item];
                total += price;
                return `<li style='margin-bottom:0.5em;'><b>${item}</b> <span class='price'>‚Çπ${price}</span></li>`;
            }).join('') + '</ul>';
            document.getElementById('summary-total').textContent = total;
            summarySection.style.display = 'block';
            console.log('showSummary() called, summary section should be visible');
        }

        // Go Back button
        document.querySelector('.back-btn').onclick = function() {
            document.getElementById('summary-section').style.display = 'none';
            document.getElementById('order-form').style.display = '';
        };

        // Add after showSummary() and before confirm button logic
        async function checkSubscriptionStatus(phone) {
            const res = await fetch(`/api/profile?phone=${phone}`);
            if (!res.ok) return { subscriptionStatus: 'None' };
            return await res.json();
        }

        // Replace confirm button logic
        // Confirm button
        document.querySelector('.confirm-btn').onclick = async function() {
            const total = selectedItems.reduce((sum, item) => sum + prices[item], 0);
            // Check subscription status
            const profile = await checkSubscriptionStatus(phone);
            // Determine time slot
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            function inRange(startH, startM, endH, endM) {
                const nowMins = hours * 60 + minutes;
                const start = startH * 60 + startM;
                const end = endH * 60 + endM;
                return nowMins >= start && nowMins <= end;
            }
            const isLunchTime = inRange(6, 0, 8, 30);
            const isDinnerTime = inRange(14, 0, 23, 30);
            // Subscription logic
            if (profile.subscriptionStatus === "Monthly" ||
                (profile.subscriptionStatus === "Monthly_Lunch" && isLunchTime) ||
                (profile.subscriptionStatus === "Monthly_Dinner" && isDinnerTime)) {
                // User is subscribed for this slot, store order directly
                await fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, items: selectedItems, total, date: new Date().toISOString() })
                });
                document.getElementById('summary-section').style.display = 'none';
                document.getElementById('close-section').style.display = 'block';
                document.getElementById('close-section').scrollIntoView({ behavior: 'smooth' });
            } else if (
                (profile.subscriptionStatus === "Monthly_Lunch" && isDinnerTime) ||
                (profile.subscriptionStatus === "Monthly_Dinner" && isLunchTime)
            ) {
                // User has a plan for the other slot, only allow pay for today
                showPaymentOptions(total, true); // true = restrict to pay today only
            } else {
                // Show all options
                showPaymentOptions(total, false);
            }
        };

        // Add payment/subscription modal logic
        function showPaymentOptions(total, restrictToPayToday) {
            // Create modal if not exists
            let modal = document.getElementById('payment-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'payment-modal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.4)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                document.body.appendChild(modal);
            } else {
                modal.style.display = 'flex';
            }
            modal.innerHTML = `
                <div style="background:#fff;padding:2em 2em 1.5em 2em;border-radius:16px;max-width:370px;text-align:center;box-shadow:0 4px 24px #0002;">
                    <h2 style='margin-bottom:1.5em;'>Choose an Option</h2>
                    <button id="pay-today-btn" class="modal-btn primary-btn" style="margin-bottom:1em;font-size:1.13em;padding:1.1em 0;border-radius:10px;letter-spacing:0.5px;">Order for Today Only<br><span style='font-size:1.05em;color:#fff8;font-weight:600;'>Pay ‚Çπ${total}</span></button><br>
                    ${restrictToPayToday ? '' : '<button id="subscribe-btn" class="modal-btn secondary-btn" style="margin-bottom:1em;font-size:1.13em;padding:1.1em 0;border-radius:10px;letter-spacing:0.5px;">Subscribe for a Month</button><br>'}
                    <button id="cancel-modal-btn" class="modal-btn cancel-btn" style="font-size:1.08em;padding:0.9em 0;border-radius:10px;">Cancel</button>
                </div>
                <style>
                    .modal-btn {
                        display: block;
                        width: 90%;
                        margin: 0.7em auto;
                        padding: 1em 0;
                        font-size: 1.15em;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        transition: box-shadow 0.2s, background 0.2s, color 0.2s;
                        font-weight: 600;
                        box-shadow: 0 2px 8px #0001;
                    }
                    .primary-btn {
                        background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
                        color: #fff;
                    }
                    .primary-btn:hover {
                        background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
                        box-shadow: 0 4px 16px #43e97b44;
                    }
                    .secondary-btn {
                        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                        color: #fff;
                    }
                    .secondary-btn:hover {
                        background: linear-gradient(90deg, #764ba2 0%, #667eea 100%);
                        box-shadow: 0 4px 16px #667eea44;
                    }
                    .cancel-btn {
                        background: #eee;
                        color: #444;
                    }
                    .cancel-btn:hover {
                        background: #ddd;
                        color: #111;
                    }
                </style>
            `;
            document.getElementById('pay-today-btn').onclick = async function() {
                // Referral code logic
                if (total < 50) {
                    alert('Referral code can only be used for payments above ‚Çπ50.');
                    // Return to summary screen instead of placing order
                    modal.style.display = 'none';
                    document.getElementById('summary-section').style.display = 'block';
                    return;
                }
                // Show referral code modal
                modal.innerHTML = `
                    <div style="background:#fff;padding:2em 2em 1.5em 2em;border-radius:18px;max-width:400px;text-align:center;box-shadow:0 4px 24px #0003;">
                        <h2 style='margin-bottom:1em;color:#2d7a2d;'>Referral Code</h2>
                        <div style='margin-bottom:1em;font-size:1.08em;color:#444;'>Enter referral code to avail <b>‚Çπ50 discount</b> (if you have one)</div>
                        <input id="referral-input" type="text" maxlength="10" style="width:85%;padding:0.9em 1em;font-size:1.13em;border-radius:8px;border:1.5px solid #43e97b;margin-bottom:1.2em;outline:none;transition:border 0.2s;" placeholder="Referral Code" onfocus="this.style.borderColor='#38f9d7'" onblur="this.style.borderColor='#43e97b'">
                        <div id="referral-error" style="color:#c00;font-size:1em;margin-bottom:1em;"></div>
                        <div style="display:flex;gap:1em;justify-content:center;">
                            <button id="apply-referral-btn" class="modal-btn primary-btn" style="flex:1;background:linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);color:#fff;font-size:1.08em;padding:0.8em 0;border-radius:8px;font-weight:600;transition:background 0.2s,box-shadow 0.2s;box-shadow:0 2px 8px #43e97b22;">Apply</button>
                            <button id="skip-referral-btn" class="modal-btn secondary-btn" style="flex:1;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);color:#fff;font-size:1.08em;padding:0.8em 0;border-radius:8px;font-weight:600;transition:background 0.2s,box-shadow 0.2s;box-shadow:0 2px 8px #667eea22;">Skip</button>
                        </div>
                    </div>
                    <style>
                        #apply-referral-btn:hover { background:linear-gradient(90deg,#38f9d7 0%,#43e97b 100%); box-shadow:0 4px 16px #43e97b44; }
                        #skip-referral-btn:hover { background:linear-gradient(90deg,#764ba2 0%,#667eea 100%); box-shadow:0 4px 16px #667eea44; }
                        #referral-input:focus { border-color:#38f9d7; }
                    </style>
                `;
                document.getElementById('apply-referral-btn').onclick = async function() {
                    const code = document.getElementById('referral-input').value.trim();
                    if (!code) {
                        document.getElementById('referral-error').textContent = 'Please enter a referral code or click Skip.';
                        return;
                    }
                    // Call backend to validate/apply referral
                    const res = await fetch('/api/apply-referral', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone, referralCode: code, amount: total })
                    });
                    const data = await res.json();
                    if (!data.success) {
                        document.getElementById('referral-error').textContent = data.message || 'Invalid referral code.';
                        return;
                    }
                    // Success: show confirmation modal with discounted amount
                    modal.innerHTML = `
                        <div style=\"background:#fff;padding:2em 2em 1.5em 2em;border-radius:18px;max-width:400px;text-align:center;box-shadow:0 4px 24px #0003;\">
                            <h2 style='margin-bottom:1em;color:#2d7a2d;'>Referral Applied!</h2>
                            <div style='margin-bottom:1em;font-size:1.08em;color:#444;'>You get <b>‚Çπ50 off</b> on your order.</div>
                            <div style='margin-bottom:1.5em;font-size:1.18em;color:#222;'>You need to pay: <b>‚Çπ${data.newAmount}</b></div>
                            <div style=\"display:flex;gap:1em;justify-content:center;\">
                                <button id=\"pay-now-btn\" class=\"modal-btn primary-btn\" style=\"flex:1;background:linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);color:#fff;font-size:1.08em;padding:0.8em 0;border-radius:8px;font-weight:600;transition:background 0.2s,box-shadow 0.2s;box-shadow:0 2px 8px #43e97b22;\">Pay Now</button>
                                <button id=\"cancel-pay-btn\" class=\"modal-btn secondary-btn\" style=\"flex:1;background:linear-gradient(90deg,#667eea 0%,#764ba2 100%);color:#fff;font-size:1.08em;padding:0.8em 0;border-radius:8px;font-weight:600;transition:background 0.2s,box-shadow 0.2s;box-shadow:0 2px 8px #667eea22;\">Cancel</button>
                            </div>
                        </div>
                        <style>
                            #pay-now-btn:hover { background:linear-gradient(90deg,#38f9d7 0%,#43e97b 100%); box-shadow:0 4px 16px #43e97b44; }
                            #cancel-pay-btn:hover { background:linear-gradient(90deg,#764ba2 0%,#667eea 100%); box-shadow:0 4px 16px #667eea44; }
                        </style>
                    `;
                    document.getElementById('pay-now-btn').onclick = async function() {
                        await new Promise(r => setTimeout(r, 1000));
                        const res = await fetch('/api/confirm-referral-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ phone, referralCode: code, amount: total, items: selectedItems, date: new Date().toISOString() })
                        });
                        const data2 = await res.json();
                        if (!data2.success) {
                            alert(data2.message || 'Something went wrong. Please try again.');
                            modal.style.display = 'none';
                            document.getElementById('summary-section').style.display = 'block';
                            return;
                        }
                        modal.style.display = 'none';
                        document.getElementById('summary-section').style.display = 'none';
                        document.getElementById('close-section').style.display = 'block';
                        document.getElementById('close-section').scrollIntoView({ behavior: 'smooth' });
                    };
                    document.getElementById('cancel-pay-btn').onclick = function() {
                        modal.style.display = 'none';
                        document.getElementById('summary-section').style.display = 'block';
                    };
                };
                document.getElementById('skip-referral-btn').onclick = async function() {
                    // Proceed with normal payment
                    await new Promise(r => setTimeout(r, 1000));
                    await fetch('/api/order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone, items: selectedItems, total, date: new Date().toISOString() })
                    });
                    modal.style.display = 'none';
                    document.getElementById('summary-section').style.display = 'none';
                    document.getElementById('close-section').style.display = 'block';
                    document.getElementById('close-section').scrollIntoView({ behavior: 'smooth' });
                };
            };
            if (!restrictToPayToday) {
                document.getElementById('subscribe-btn').onclick = function() {
                    showSubscriptionTypeModal(total);
                };
            }
            document.getElementById('cancel-modal-btn').onclick = function() {
                modal.style.display = 'none';
                document.getElementById('summary-section').style.display = 'none';
                showIncompleteOrderMessage();
            };
        }

        function showSubscriptionTypeModal(orderTotal) {
            let modal = document.getElementById('payment-modal');
            modal.innerHTML = `
                <div style="background:#fff;padding:2em 2em 1.5em 2em;border-radius:18px;max-width:400px;text-align:center;box-shadow:0 4px 24px #0002;">
                    <h2 style='margin-bottom:2em;'>Choose Your Subscription</h2>
                    <div class="sub-btns-wrap">
                        <button id="sub-lunch" class="sub-btn sub-lunch-btn">
                            <span class="sub-icon">‚òÄÔ∏è</span>
                            <span class="sub-label">Daily Lunch</span>
                            <span class="sub-price">‚Çπ2000</span>
                        </button>
                        <button id="sub-dinner" class="sub-btn sub-dinner-btn">
                            <span class="sub-icon">üåô</span>
                            <span class="sub-label">Daily Dinner</span>
                            <span class="sub-price">‚Çπ2000</span>
                        </button>
                        <button id="sub-both" class="sub-btn sub-both-btn">
                            <span class="sub-icon">‚òÄÔ∏è+üåô</span>
                            <span class="sub-label">Both (Lunch & Dinner)</span>
                            <span class="sub-price">‚Çπ3500</span>
                        </button>
                    </div>
                    <button id="cancel-sub-btn" class="sub-cancel-btn">Cancel</button>
                </div>
                <style>
                    .sub-btns-wrap {
                        display: flex;
                        flex-direction: column;
                        gap: 1.2em;
                        margin-bottom: 1.5em;
                    }
                    .sub-btn {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        width: 100%;
                        padding: 1.2em 1.5em;
                        font-size: 1.18em;
                        font-weight: 700;
                        border: none;
                        border-radius: 12px;
                        box-shadow: 0 2px 12px #0001;
                        cursor: pointer;
                        transition: box-shadow 0.2s, background 0.2s, color 0.2s, transform 0.15s;
                        margin: 0 auto;
                        background: #f7f7f7;
                        position: relative;
                        outline: none;
                    }
                    .sub-btn .sub-icon {
                        font-size: 1.5em;
                        margin-right: 0.7em;
                    }
                    .sub-btn .sub-label {
                        flex: 1;
                        text-align: left;
                    }
                    .sub-btn .sub-price {
                        font-size: 1.1em;
                        color: #fff;
                        background: #222;
                        border-radius: 6px;
                        padding: 0.25em 0.7em;
                        margin-left: 1em;
                        font-weight: 600;
                        letter-spacing: 0.5px;
                    }
                    .sub-lunch-btn {
                        background: linear-gradient(90deg, #f7971e 0%, #ffd200 100%);
                        color: #fff;
                    }
                    .sub-lunch-btn:hover {
                        background: linear-gradient(90deg, #ffd200 0%, #f7971e 100%);
                        box-shadow: 0 6px 24px #ffd20055;
                        transform: translateY(-2px) scale(1.03);
                    }
                    .sub-dinner-btn {
                        background: linear-gradient(90deg, #4e54c8 0%, #8f94fb 100%);
                        color: #fff;
                    }
                    .sub-dinner-btn:hover {
                        background: linear-gradient(90deg, #8f94fb 0%, #4e54c8 100%);
                        box-shadow: 0 6px 24px #8f94fb55;
                        transform: translateY(-2px) scale(1.03);
                    }
                    .sub-both-btn {
                        background: linear-gradient(90deg, #43cea2 0%, #185a9d 100%);
                        color: #fff;
                    }
                    .sub-both-btn:hover {
                        background: linear-gradient(90deg, #185a9d 0%, #43cea2 100%);
                        box-shadow: 0 6px 24px #43cea255;
                        transform: translateY(-2px) scale(1.03);
                    }
                    .sub-cancel-btn {
                        margin-top: 0.5em;
                        background: #eee;
                        color: #444;
                        border: none;
                        border-radius: 8px;
                        padding: 0.9em 2em;
                        font-size: 1.08em;
                        font-weight: 600;
                        cursor: pointer;
                        transition: background 0.2s, color 0.2s;
                    }
                    .sub-cancel-btn:hover {
                        background: #ddd;
                        color: #111;
                    }
                </style>
            `;
            document.getElementById('sub-lunch').onclick = function() { handleSubscription('Monthly_Lunch', 2000, orderTotal); };
            document.getElementById('sub-dinner').onclick = function() { handleSubscription('Monthly_Dinner', 2000, orderTotal); };
            document.getElementById('sub-both').onclick = function() { handleSubscription('Monthly', 3500, orderTotal); };
            document.getElementById('cancel-sub-btn').onclick = function() {
                modal.style.display = 'none';
                document.getElementById('summary-section').style.display = 'none';
                showIncompleteOrderMessage();
            };
        }

        async function handleSubscription(type, subAmount, orderTotal) {
            let modal = document.getElementById('payment-modal');
            // Dummy payment
            await new Promise(r => setTimeout(r, 1000));
            // Update profile subscription
            await fetch('/api/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone, type })
            });
            // Store order
            await fetch('/api/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone, items: selectedItems, total: orderTotal, date: new Date().toISOString() })
            });
            modal.style.display = 'none';
            document.getElementById('summary-section').style.display = 'none';
            document.getElementById('close-section').style.display = 'block';
            document.getElementById('close-section').scrollIntoView({ behavior: 'smooth' });
        }

        function showIncompleteOrderMessage() {
            let modal = document.getElementById('incomplete-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'incomplete-modal';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100vw';
                modal.style.height = '100vh';
                modal.style.background = 'rgba(0,0,0,0.4)';
                modal.style.display = 'flex';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                modal.innerHTML = `
                    <div style="background:#fff;padding:2em 2em 1.5em 2em;border-radius:10px;max-width:350px;text-align:center;">
                        <h2>Order Not Completed</h2>
                        <div style='margin:1em 0 2em 0;'>Your order was not completed and will be discarded.</div>
                        <button id="close-incomplete-btn" style="background:#2d7a2d;color:#fff;padding:0.7em 2em;border:none;border-radius:5px;">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                modal.style.display = 'flex';
            }
            document.getElementById('close-incomplete-btn').onclick = function() {
                modal.style.display = 'none';
            };
        }

        // Close window button
        document.querySelector('.close-btn').onclick = function() {
            window.close();
        };

        // Add Save Default button and info message
        function addSaveDefaultButton(type, disabled, disableMsg) {
            // Only add if not already present
            if (document.getElementById('save-default-btn')) return;
            const form = document.getElementById('order-form');
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.id = 'save-default-btn';
            btn.className = 'submit-btn';
            btn.style.background = '#0077cc';
            btn.style.marginTop = '0.5em';
            btn.textContent = 'Save these items for everyday';
            if (disabled) {
                btn.disabled = true;
                btn.style.opacity = '0.6';
            }
            const info = document.createElement('div');
            info.style.fontSize = '0.98em';
            info.style.margin = '0.5em 0 1.2em 0';
            info.style.color = '#444';
            info.innerHTML = disableMsg || "If on some day you don't select food items to order these default items will be stored as the order. You can cancel your order though if you don't want to receive on that particular day.";
            form.appendChild(btn);
            form.appendChild(info);
            btn.onclick = async function() {
                selectedItems = Array.from(document.querySelectorAll('input[name="order"]:checked')).map(cb => cb.value);
                if (selectedItems.length === 0) {
                    alert('Please select at least one item to save as default.');
                    return;
                }
                btn.disabled = true;
                btn.textContent = 'Saving...';
                try {
                    const res = await fetch('/api/save-default-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone, items: selectedItems, type })
                    });
                    if (res.ok) {
                        btn.textContent = 'Saved!';
                        info.innerHTML = `These items are now saved as your default ${type === 'lunch' ? 'lunch' : 'dinner'} order for every day.`;
                    } else {
                        btn.textContent = 'Save these items for everyday';
                        alert('Failed to save default order.');
                    }
                } catch (e) {
                    btn.textContent = 'Save these items for everyday';
                    alert('Failed to save default order.');
                }
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = 'Save these items for everyday';
                }, 2000);
            };
        }
    </script>
</body>
</html> 